From dedfffafcbef505166b13e8487057cbac4a3c742 Mon Sep 17 00:00:00 2001
From: Legimet <legimet.calc@gmail.com>
Date: Sat, 24 May 2014 16:18:03 -0400
Subject: [PATCH] Modify for TI-Nspire

---
 Makerules             |   10 ++++++++++
 source/cbz/mucbz.c    |   13 +++++++++++++
 source/img/muimage.c  |   16 ++++++++++++++++
 source/pdf/pdf-xref.c |   13 +++++++++++++
 source/tiff/mutiff.c  |   13 +++++++++++++
 source/xps/xps-doc.c  |   13 +++++++++++++
 6 files changed, 78 insertions(+)

diff --git a/Makerules b/Makerules
index 682160c..8d5c19b 100644
--- a/Makerules
+++ b/Makerules
@@ -130,6 +130,16 @@ AR = x86_64-w64-mingw32-ar
 CROSSCOMPILE=yes
 endif
 
+ifeq "$(OS)" "ti-nspire"
+CC = nspire-gcc
+LD = nspire-ld-bflt
+AR = arm-none-eabi-ar
+ifeq "$(build)" "release"
+CFLAGS += -Os
+endif
+CROSSCOMPILE=yes
+endif
+
 # Most variables when building for iOS are set up in ios/build_libs.sh,
 # which is called from the Xcode project as a "Run Script" build step.
 # The following section works for both device and simulator builds.
diff --git a/source/cbz/mucbz.c b/source/cbz/mucbz.c
index dc36e0b..bc9ed78 100644
--- a/source/cbz/mucbz.c
+++ b/source/cbz/mucbz.c
@@ -440,6 +440,19 @@ cbz_recognize(fz_context *doc, const char *magic)
 	{
 		if (!fz_strcasecmp(ext, ".cbz") || !fz_strcasecmp(ext, ".zip"))
 			return 100;
+
+#ifdef _TINSPIRE
+		if (!fz_strcasecmp(ext, ".tns"))
+		{
+			while (--ext >= magic)
+			{
+				if (*ext == '.')
+					break;
+			}
+			if (ext >= magic && (!fz_strcasecmp(ext, ".cbz.tns") || !fz_strcasecmp(ext, ".zip.tns")))
+				return 100;
+		}
+#endif
 	}
 	if (!strcmp(magic, "cbz") || !strcmp(magic, "application/x-cbz"))
 		return 100;
diff --git a/source/img/muimage.c b/source/img/muimage.c
index d545068..8224a5b 100644
--- a/source/img/muimage.c
+++ b/source/img/muimage.c
@@ -166,6 +166,22 @@ image_recognize(fz_context *doc, const char *magic)
 			!fz_strcasecmp(ext, ".jpeg") || !fz_strcasecmp(ext, ".jfif") ||
 			!fz_strcasecmp(ext, ".jfif-tbnl") || !fz_strcasecmp(ext, ".jpe"))
 			return 100;
+
+#ifdef _TINSPIRE
+		if (!fz_strcasecmp(ext, ".tns"))
+		{
+			while (--ext >= magic)
+			{
+				if (*ext == '.')
+					break;
+			}
+			if (ext >= magic &&
+				(!fz_strcasecmp(ext, ".png.tns") || !fz_strcasecmp(ext, ".jpg.tns") ||
+				!fz_strcasecmp(ext, ".jpeg.tns") || !fz_strcasecmp(ext, ".jfif.tns") ||
+				!fz_strcasecmp(ext, ".jfif-tbnl.tns") || !fz_strcasecmp(ext, ".jpe.tns")))
+				return 100;
+		}
+#endif
 	}
 	if (!strcmp(magic, "png") || !strcmp(magic, "image/png") ||
 		!strcmp(magic, "jpg") || !strcmp(magic, "image/jpeg") ||
diff --git a/source/pdf/pdf-xref.c b/source/pdf/pdf-xref.c
index 9bf735d..6010de3 100644
--- a/source/pdf/pdf-xref.c
+++ b/source/pdf/pdf-xref.c
@@ -2444,6 +2444,19 @@ pdf_recognize(fz_context *doc, const char *magic)
 	{
 		if (!fz_strcasecmp(ext, ".pdf"))
 			return 100;
+
+#ifdef _TINSPIRE
+		if (!fz_strcasecmp(ext, ".tns"))
+		{
+			while (--ext >= magic)
+			{
+				if (*ext == '.')
+					break;
+			}
+			if (ext >= magic && !fz_strcasecmp(ext, ".pdf.tns"))
+				return 100;
+		}
+#endif
 	}
 	if (!strcmp(magic, "pdf") || !strcmp(magic, "application/pdf"))
 		return 100;
diff --git a/source/tiff/mutiff.c b/source/tiff/mutiff.c
index e2772f1..8c0b90e 100644
--- a/source/tiff/mutiff.c
+++ b/source/tiff/mutiff.c
@@ -191,6 +191,19 @@ tiff_recognize(fz_context *doc, const char *magic)
 	{
 		if (!fz_strcasecmp(ext, ".tiff") || !fz_strcasecmp(ext, ".tif"))
 			return 100;
+
+#ifdef _TINSPIRE
+		if (!fz_strcasecmp(ext, ".tns"))
+		{
+			while (--ext >= magic)
+			{
+				if (*ext == '.')
+					break;
+			}
+			if (ext >= magic && (!fz_strcasecmp(ext, ".tiff.tns") || !fz_strcasecmp(ext, ".tif.tns")))
+				return 100;
+		}
+#endif
 	}
 	if (!strcmp(magic, "tif") || !strcmp(magic, "image/tiff") ||
 		!strcmp(magic, "tiff") || !strcmp(magic, "image/x-tiff"))
diff --git a/source/xps/xps-doc.c b/source/xps/xps-doc.c
index af5bfe5..909e489 100644
--- a/source/xps/xps-doc.c
+++ b/source/xps/xps-doc.c
@@ -541,6 +541,19 @@ xps_recognize(fz_context *doc, const char *magic)
 	{
 		if (!fz_strcasecmp(ext, ".xps") || !fz_strcasecmp(ext, ".rels") || !fz_strcasecmp(ext, ".oxps"))
 			return 100;
+
+#ifdef _TINSPIRE
+		if (!fz_strcasecmp(ext, ".tns"))
+		{
+			while (--ext >= magic)
+			{
+				if (*ext == '.')
+					break;
+			}
+			if (ext >= magic && (!fz_strcasecmp(ext, ".xps.tns") || !fz_strcasecmp(ext, ".rels.tns") || !fz_strcasecmp(ext, ".oxps.tns")))
+				return 100;
+		}
+#endif
 	}
 	if (!strcmp(magic, "xps") || !strcmp(magic, "oxps") ||
 		!strcmp(magic, "application/vnd.ms-xpsdocument") ||
-- 
1.7.9.5

